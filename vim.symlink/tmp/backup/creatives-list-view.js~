/* global dependencies */
var $ = require('jquery');
var Marionette = require('backbone.marionette');
require('backbone.stickit');

/* templates */
var SCTastypieCollectionTemplate = require('../../../../common/templates/SCTastypieCollection.hbs');
var facebookpreviewTemplate = require('../../templates/facebookpreview.hbs');
var creativemodalTemplate = require('../../templates/creativemodal.hbs');

/* local dependencies */
var FacebookCreativeView = require('./facebook-creative-view');
var EmptyCollection = require('../../../../common/empty-view');

var CreativesListView = Marionette.CompositeView.extend({
    template: SCTastypieCollectionTemplate,
    childView: FacebookCreativeView,
    childViewContainer: '.child-objects',
    childViewOptions: function(model, index) {
        var isPost = model.has('story_id');
        var thumbnail = isPost ? model.get('picture') : model.get('image_url');
        return {
            is_pagepost: isPost,
            thumbnail: thumbnail
        };
    },
    getEmptyView: function() {
        return EmptyCollection.extend({
            tagName: 'tr'
        });
    },
    emptyViewOptions: {
        table: true,
        message: 'No creatives found',
        columns: 6
    },
    events: {
        'show.bs.modal': 'showPreview',
        'click button.show-more': 'moreItems'
    },
    initialize: function() {
        // Handle the pagination button on initial render and after paging
        this.on('add:child render', this.updatePagination);
    },
    onRender: function() {
        this.$el.append(creativemodalTemplate());
    },
    onShow: function() {
        $('#creative-modal').on('show.bs.modal', _(this.showPreview).bind(this));
    },
    updatePagination: function() {
        if (this.collection.meta.next) {
            this.$('button.show-more').button('reset');
        } else {
            this.$('button.show-more').remove();
        }
    },
    showPreview: function(event) {
        var post_id = $(event.relatedTarget).data('post-id');
        var placement = 'DESKTOP_FEED_STANDARD';
        var creative_spec = JSON.stringify({
            object_story_id: post_id
        });
        this.$('.modal-body').html(
            facebookpreviewTemplate({
                creative_spec: creative_spec,
                placement: placement
            })
        );
        FB.XFBML.parse(this.$('.modal-body')[0]);
    },
    moreItems: function() {
        this.collection.fetch({
            url: this.collection.meta.next,
            remove: false
        });
        this.$('button.show-more').button('loading');
    },
    templateHelpers: function() {
        return {
            page_posts: this.getOption('types').indexOf('status') >= 0
        };
    }
});

module.exports = CreativesListView;
