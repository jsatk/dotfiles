(function () {
  function main (notes) {
    console.log(notes.length)
    this.users = {}
    debugger;

    // Clear our notes and stats from last run
    document.getElementById('chat-stats').querySelector('.users').innerHTML = ''
    document.getElementById('chats').innerHTML = ''

    // Iterate over the notes rendering them and updating our user object.
    notes.forEach(function (note) {
      renderNote(note)
      updateUsers.bind(this)(note)
    }, this)

    for (var key in this.users) {
      renderStat(this.users[key])
    }

    bindClickEvents()
  }

  function renderNote (note) {
    var noteObj = window.NoteObj(note)

    document.getElementById('chats')
      .appendChild(noteObj.element)
    noteObj.draw()
  }

  function updateUsers (note) {
    var user = note.user.toLowerCase()

    if (!this.users[user]) {
      this.users[user] = { name: note.user, count: 1 }
    } else {
      this.users[user].count++
    }
  }

  function renderStat (stat) {
    var statObj = window.StatObj(stat)

    document.getElementById('chat-stats')
      .querySelector('.users')
      .appendChild(statObj.element)

    statObj.draw()
  }

  function bindClickEvents () {
    var userElements = document.getElementsByClassName('user')

    for (var i = userElements.length - 1; i >= 0; i--) {
      userElements[i].addEventListener('click', highlightChats)
    }
  }

  function addOverlay (chats) {
    var overlay = document.createElement('div')

    overlay.id = 'overlay'
    overlay.style.zIndex = 1
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)'
    overlay.style.position = 'fixed'
    overlay.style.height = '100%'
    overlay.style.width = '100%'
    overlay.addEventListener('click', function () {
      chats.forEach(function (chat) {
        chat.style.zIndex = 0
      })

      document.body.removeChild(overlay)
    })

    document.body.appendChild(overlay)
  }

  function highlightChats (event) {
    // Normally I'd prefer to store this info on the class or in a data
    // attribute, however the README requested we not modify the markup
    // so this is the most elegant way to get the artist's name.
    var artist = event.currentTarget.querySelector('.name').textContent.toLowerCase()
    var chats = document.getElementsByClassName('chat-entry')
    var artistsChats = []

    for (var i = chats.length - 1; i >= 0; i--) {
      var chat = chats[i]
      var chatArtist = chat.querySelector('.creator')
                            .getElementsByTagName('span')[1]
                            .textContent
                            .toLowerCase()

      if (chatArtist === artist) {
        chat.style.zIndex = 2
        artistsChats.push(chat)
      }
    }

    addOverlay(artistsChats)
  }

  window.note_emitter(main)
}())
