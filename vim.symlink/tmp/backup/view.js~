/* global dependencies */
var $ = require('jquery');
var _ = require('underscore');
var moment = require('moment');
var Handlebars = require('handlebars');

/* local dependencies */
var CampaignModuleBulkView = require('../view');

/* templates */
var BulkReportFormTemplate = require('advisor/modules/campaign/templates/bulk/BulkReportForm.hbs');

/* module definition */
module.exports = CampaignModuleBulkView.extend({
    /** Template */
    template: BulkReportFormTemplate,
    /** UI references */
    ui: {
        startDate: '#start_date',
        endDate: '#end_date',
        cancel: '#cancel',
        submit: '#submit',
        error: '#error',
        form: 'form'
    },
    events: {
        'click @ui.submit': 'updateSubmitUrl'
    },
    /** Marionette template helpers */
    templateHelpers: function() {
        return {
            endDate: this.model.get('endDate'),
            platform: this.model.get('platform'),
            startDate: this.model.get('startDate')
        };
    },
    updateSubmitUrl: function(event) {
        event.preventDefault();

        var startDate = moment(this.ui.startDate.val(), 'MM/DD/YYYY').format('YYYY-MM-DD');
        var endDate = moment(this.ui.endDate.val(), 'MM/DD/YYYY').format('YYYY-MM-DD');

        window.location.href = '/api/advisor/v1/campaign/' +
            this.model.get('campaignID') +
            '/excel_report/?format=json&' + this.getPickedID(this.collection) +
            '&date__gte=' + startDate +
            '&date__lte=' + endDate;
    },
    getPickedID: function(collection) {
        /** Get model ids from collection */
        return $.param(
            _(collection.pluck('id')).map(function(value) {
                return {
                    name: 'ids',
                    value: value
                };
            })
        );
    }
});
